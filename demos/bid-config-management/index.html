<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出价配置管理 - 广告管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <style>
        .package-counter {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 12px;
            color: #6c757d;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .package-textarea-container {
            position: relative;
        }
        .hover-link {
            color: #0d6efd;
            text-decoration: none;
            cursor: pointer;
        }
        .hover-link:hover {
            text-decoration: underline;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        .autocomplete-item:hover, .autocomplete-item.active {
            background-color: #e9ecef;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../index.html">
                <i class="fas fa-home"></i> 返回首页
            </a>
            <span class="navbar-text">
                <i class="fas fa-chart-line"></i> 广告管理系统 - 出价配置管理
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 页面标题和操作按钮 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>
                        <i class="fas fa-cogs text-primary"></i>
                        出价配置管理
                    </h2>
                    <button type="button" class="btn btn-success btn-lg" onclick="showAddConfigModal()">
                        <i class="fas fa-plus"></i> 添加出价配置
                    </button>
                </div>
            </div>
        </div>

        <!-- 筛选区域 -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter text-info"></i>
                筛选条件
            </h5>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Channel UUID</label>
                    <div class="position-relative">
                        <input type="text" class="form-control" id="filterChannelUuid" 
                               placeholder="输入关键词搜索Channel UUID" onkeyup="filterChannelAutocomplete(this)">
                        <div class="autocomplete-dropdown" id="filterChannelDropdown"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Package List</label>
                    <input type="text" class="form-control" id="filterPackage" 
                           placeholder="输入包名筛选">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                        <i class="fas fa-search"></i> 筛选
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> 清除
                    </button>
                </div>
            </div>
        </div>

        <!-- 配置记录列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list text-primary"></i>
                    配置记录列表
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>配置ID</th>
                                <th>Channel UUID</th>
                                <th>Channel Payout</th>
                                <th>Package List</th>
                                <th>更新时间</th>
                                <th width="120">操作</th>
                            </tr>
                        </thead>
                        <tbody id="configTableBody">
                            <!-- 配置记录将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑配置模态框 -->
    <div class="modal fade" id="configModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalTitle">
                        <i class="fas fa-plus text-success"></i>
                        添加出价配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <input type="hidden" id="configId" value="">
                        
                        <!-- Channel UUID -->
                        <div class="mb-3">
                            <label class="form-label">Channel UUID <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="channelUuid" 
                                       placeholder="输入关键词搜索Channel UUID" required
                                       onkeyup="channelAutocomplete(this)" onfocus="channelAutocomplete(this)">
                                <div class="autocomplete-dropdown" id="channelDropdown"></div>
                            </div>
                        </div>

                        <!-- Channel Payout -->
                        <div class="mb-3">
                            <label class="form-label">Channel Payout <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="channelPayout" 
                                       placeholder="0.001" step="0.001" min="0.001" max="100.000" required>
                            </div>
                            <small class="text-muted">范围：0.001 - 100.000</small>
                        </div>

                        <!-- Package List -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Package List <span class="text-danger">*</span></label>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="showDeletePackageModal()">
                                    <i class="fas fa-trash"></i> 指定Package删除
                                </button>
                            </div>
                            <div class="package-textarea-container">
                                <textarea class="form-control" id="packageList" rows="8" required
                                          placeholder="请输入Package，多个Package用逗号或换行符分隔"
                                          oninput="updatePackageCounter()"></textarea>
                                <div class="package-counter" id="packageCounter">已输入 0 个Package</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveConfig()">
                        <i class="fas fa-save"></i> 确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除Package模态框 -->
    <div class="modal fade" id="deletePackageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-trash text-danger"></i>
                        指定Package删除
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">要删除的Package</label>
                    <textarea class="form-control" id="packagesToDelete" rows="5"
                              placeholder="请输入要删除的Package，多个Package用逗号或换行符分隔"></textarea>
                    <small class="text-muted">注意：此操作只在前端删除，未提交到后端保存</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="deleteSpecifiedPackages()">
                        <i class="fas fa-check"></i> 确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        确认删除
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确认要删除此配置记录吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash"></i> 确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
        // 模拟数据
        const mockChannels = [
            'abc', 'abcd', 'abcd_01', 'xyz_channel', 'test_channel_01', 
            'prod_channel_02', 'demo_abc', 'sample_xyz', 'channel_test'
        ];

        let configData = [
            {
                id: 'CFG001',
                channelUuid: 'abc',
                channelPayout: 0.030,
                packageList: ['com.example.app1', 'com.example.app2', 'com.test.package1'],
                updateTime: '2025-09-02 15:23'
            },
            {
                id: 'CFG002', 
                channelUuid: 'abcd_01',
                channelPayout: 0.045,
                packageList: Array.from({length: 30}, (_, i) => `com.demo.package${i+1}`),
                updateTime: '2025-09-01 14:15'
            }
        ];

        let filteredData = [...configData];
        let editingConfigId = null;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            renderConfigTable();
        });

        // 渲染配置表格
        function renderConfigTable() {
            const tbody = document.getElementById('configTableBody');
            tbody.innerHTML = filteredData.map(config => `
                <tr>
                    <td>${config.id}</td>
                    <td>${config.channelUuid}</td>
                    <td>
                        <a href="https://3s.mobvista.com/dist/index.html#!/Channel/TrafficSource" 
                           target="_blank" class="hover-link" 
                           title="点击查看渠道的更多出价配置">
                            ${config.channelPayout.toFixed(3)}
                        </a>
                    </td>
                    <td>
                        <a href="javascript:void(0)" class="hover-link" 
                           onclick="editConfig('${config.id}')" 
                           title="点击编辑配置记录">
                            ${config.packageList.length}个Package
                        </a>
                    </td>
                    <td>${config.updateTime}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editConfig('${config.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${config.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Channel UUID自动完成
        function channelAutocomplete(input) {
            const dropdown = document.getElementById('channelDropdown');
            const value = input.value.toLowerCase();
            
            if (!value) {
                dropdown.style.display = 'none';
                return;
            }

            const matches = mockChannels.filter(channel => 
                channel.toLowerCase().includes(value)
            );

            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = matches.map(channel => `
                <div class="autocomplete-item" onclick="selectChannel('${channel}', 'channelUuid')">
                    ${channel}
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        // 筛选用的Channel UUID自动完成
        function filterChannelAutocomplete(input) {
            const dropdown = document.getElementById('filterChannelDropdown');
            const value = input.value.toLowerCase();
            
            if (!value) {
                dropdown.style.display = 'none';
                return;
            }

            const matches = mockChannels.filter(channel => 
                channel.toLowerCase().includes(value)
            );

            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = matches.map(channel => `
                <div class="autocomplete-item" onclick="selectChannel('${channel}', 'filterChannelUuid')">
                    ${channel}
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        // 选择Channel
        function selectChannel(channel, inputId) {
            document.getElementById(inputId).value = channel;
            document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }

        // 更新Package计数器
        function updatePackageCounter() {
            const textarea = document.getElementById('packageList');
            const counter = document.getElementById('packageCounter');
            const content = textarea.value.trim();
            
            if (!content) {
                counter.textContent = '已输入 0 个Package';
                return;
            }

            // 统一处理逗号和换行符分隔
            const packages = content.split(/[,\n]/).map(p => p.trim()).filter(p => p);
            counter.textContent = `已输入 ${packages.length} 个Package`;
        }

        // 显示添加配置模态框
        function showAddConfigModal() {
            editingConfigId = null;
            document.getElementById('configModalTitle').innerHTML = '<i class="fas fa-plus text-success"></i> 添加出价配置';
            document.getElementById('configForm').reset();
            document.getElementById('configId').value = '';
            document.getElementById('channelUuid').disabled = false;
            updatePackageCounter();
            new bootstrap.Modal(document.getElementById('configModal')).show();
        }

        // 编辑配置
        function editConfig(configId) {
            const config = configData.find(c => c.id === configId);
            if (!config) return;

            editingConfigId = configId;
            document.getElementById('configModalTitle').innerHTML = '<i class="fas fa-edit text-primary"></i> 编辑出价配置';
            document.getElementById('configId').value = config.id;
            document.getElementById('channelUuid').value = config.channelUuid;
            document.getElementById('channelUuid').disabled = true; // 编辑时不可修改
            document.getElementById('channelPayout').value = config.channelPayout;
            document.getElementById('packageList').value = config.packageList.join('\n');
            updatePackageCounter();
            new bootstrap.Modal(document.getElementById('configModal')).show();
        }

        // 保存配置
        function saveConfig() {
            const form = document.getElementById('configForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const channelUuid = document.getElementById('channelUuid').value;
            const channelPayout = parseFloat(document.getElementById('channelPayout').value);
            const packageListText = document.getElementById('packageList').value.trim();
            
            if (!packageListText) {
                Utils.showToast('请输入Package List', 'warning');
                return;
            }

            const packageList = packageListText.split(/[,\n]/).map(p => p.trim()).filter(p => p);
            
            if (packageList.length === 0) {
                Utils.showToast('请输入有效的Package', 'warning');
                return;
            }

            const now = new Date();
            const updateTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            if (editingConfigId) {
                // 编辑现有配置
                const configIndex = configData.findIndex(c => c.id === editingConfigId);
                configData[configIndex] = {
                    ...configData[configIndex],
                    channelPayout,
                    packageList,
                    updateTime
                };
                Utils.showToast('配置更新成功', 'success');
            } else {
                // 添加新配置
                const newConfig = {
                    id: 'CFG' + String(Date.now()).slice(-6),
                    channelUuid,
                    channelPayout,
                    packageList,
                    updateTime
                };
                configData.unshift(newConfig);
                Utils.showToast('配置添加成功', 'success');
            }

            // 重新排序（按更新时间倒序）
            configData.sort((a, b) => new Date(b.updateTime) - new Date(a.updateTime));
            applyFilters();
            bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
        }

        // 显示删除Package模态框
        function showDeletePackageModal() {
            document.getElementById('packagesToDelete').value = '';
            new bootstrap.Modal(document.getElementById('deletePackageModal')).show();
        }

        // 删除指定Package
        function deleteSpecifiedPackages() {
            const packagesToDelete = document.getElementById('packagesToDelete').value.trim();
            if (!packagesToDelete) {
                Utils.showToast('请输入要删除的Package', 'warning');
                return;
            }

            const deleteList = packagesToDelete.split(/[,\n]/).map(p => p.trim()).filter(p => p);
            const currentPackages = document.getElementById('packageList').value.split(/[,\n]/).map(p => p.trim()).filter(p => p);
            
            const remainingPackages = currentPackages.filter(pkg => !deleteList.includes(pkg));
            
            document.getElementById('packageList').value = remainingPackages.join('\n');
            updatePackageCounter();
            
            Utils.showToast(`已删除 ${currentPackages.length - remainingPackages.length} 个Package`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('deletePackageModal')).hide();
        }

        // 确认删除配置
        function confirmDelete(configId) {
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            document.getElementById('confirmDeleteBtn').onclick = () => deleteConfig(configId);
            modal.show();
        }

        // 删除配置
        function deleteConfig(configId) {
            configData = configData.filter(c => c.id !== configId);
            applyFilters();
            Utils.showToast('配置删除成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        }

        // 应用筛选
        function applyFilters() {
            const channelFilter = document.getElementById('filterChannelUuid').value.trim();
            const packageFilter = document.getElementById('filterPackage').value.trim().toLowerCase();

            filteredData = configData.filter(config => {
                const channelMatch = !channelFilter || config.channelUuid === channelFilter;
                const packageMatch = !packageFilter || config.packageList.some(pkg => 
                    pkg.toLowerCase().includes(packageFilter)
                );
                return channelMatch && packageMatch;
            });

            renderConfigTable();
        }

        // 清除筛选
        function clearFilters() {
            document.getElementById('filterChannelUuid').value = '';
            document.getElementById('filterPackage').value = '';
            document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            filteredData = [...configData];
            renderConfigTable();
        }

        // 点击其他地方关闭下拉框
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.position-relative')) {
                document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>