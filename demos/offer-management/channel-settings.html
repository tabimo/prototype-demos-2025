<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>渠道对接设置 - 广告管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../index.html">
                <i class="fas fa-home"></i> 返回首页
            </a>
            <span class="navbar-text">
                <i class="fas fa-cogs"></i> 广告管理系统 - 渠道对接设置
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 页面头部 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h4 class="mb-2">
                            <i class="fas fa-link text-success"></i>
                            渠道对接设置
                        </h4>
                        <p class="mb-0 text-muted">
                            为Offer "<span id="offerName" class="fw-bold text-primary">示例Offer</span>" 配置各个渠道的对接参数
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量操作工具栏 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-tools text-info"></i>
                    批量操作
                </h5>
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">批量设置Channel Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="batchPrice" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">批量设置Daily Cap</label>
                        <input type="number" class="form-control" id="batchDailyCap" placeholder="1000" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">批量设置Daily Click Cap</label>
                        <input type="number" class="form-control" id="batchDailyClickCap" placeholder="10000" min="0">
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-info" onclick="applyBatchSettings()">
                                <i class="fas fa-magic"></i> 应用到选中渠道
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 渠道设置表格 -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table text-primary"></i>
                        渠道对接参数设置
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllChannels()">
                            <i class="fas fa-check-square"></i> 全选
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllSelections()">
                            <i class="fas fa-square"></i> 清除选择
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="channelSettingsTable">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>渠道信息</th>
                                <th width="120">Channel Price *</th>
                                <th width="120">Daily Cap</th>
                                <th width="120">Daily Click Cap</th>
                                <th width="100">Deduction (%)</th>
                                <th width="100">状态</th>
                                <th width="150">备注</th>
                            </tr>
                        </thead>
                        <tbody id="channelTableBody">
                            <!-- 渠道行将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-secondary me-3" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i> 返回上一步
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="submitChannelSettings()">
                    <i class="fas fa-check"></i> 提交设置
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
        // 模拟渠道数据
        const mockChannels = {
            'ch-001-facebook': { uuid: 'ch-001-facebook', name: 'Facebook Ads', type: 'Social Media' },
            'ch-002-google': { uuid: 'ch-002-google', name: 'Google Ads', type: 'Search Engine' },
            'ch-003-tiktok': { uuid: 'ch-003-tiktok', name: 'TikTok Ads', type: 'Social Media' },
            'ch-004-youtube': { uuid: 'ch-004-youtube', name: 'YouTube Ads', type: 'Video Platform' },
            'ch-005-instagram': { uuid: 'ch-005-instagram', name: 'Instagram Ads', type: 'Social Media' },
            'ch-006-twitter': { uuid: 'ch-006-twitter', name: 'Twitter Ads', type: 'Social Media' },
            'ch-007-linkedin': { uuid: 'ch-007-linkedin', name: 'LinkedIn Ads', type: 'Professional' },
            'ch-008-snapchat': { uuid: 'ch-008-snapchat', name: 'Snapchat Ads', type: 'Social Media' }
        };

        // 获取URL参数中的渠道列表
        function getSelectedChannels() {
            const urlParams = new URLSearchParams(window.location.search);
            const channelsParam = urlParams.get('channels');
            if (channelsParam) {
                return channelsParam.split(',').map(uuid => mockChannels[uuid]).filter(Boolean);
            }
            // 如果没有参数，返回示例渠道
            return [mockChannels['ch-001-facebook'], mockChannels['ch-002-google']];
        }

        // 生成渠道设置表格
        function generateChannelSettings() {
            const selectedChannels = getSelectedChannels();
            const tbody = document.getElementById('channelTableBody');
            
            tbody.innerHTML = selectedChannels.map(channel => `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input channel-checkbox" 
                               value="${channel.uuid}" onchange="updateSelectAllState()">
                    </td>
                    <td>
                        <div>
                            <strong>${channel.name}</strong>
                            <span class="badge bg-secondary ms-2">${channel.type}</span>
                            <br>
                            <small class="text-muted">UUID: ${channel.uuid}</small>
                        </div>
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="price_${channel.uuid}" 
                                   placeholder="0.00" step="0.01" min="0" required>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" id="dailyCap_${channel.uuid}" 
                               placeholder="1000" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" id="dailyClickCap_${channel.uuid}" 
                               placeholder="10000" min="0">
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="deduction_${channel.uuid}" 
                                   placeholder="0" step="0.1" min="0" max="100">
                            <span class="input-group-text">%</span>
                        </div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" id="status_${channel.uuid}">
                            <option value="active" selected>激活</option>
                            <option value="paused">暂停</option>
                            <option value="testing">测试中</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" id="notes_${channel.uuid}" 
                               placeholder="备注...">
                    </td>
                </tr>
            `).join('');
        }

        // 批量设置功能
        function applyBatchSettings() {
            const selectedChannels = getSelectedChannelUuids();
            if (selectedChannels.length === 0) {
                Utils.showToast('请先选择要批量设置的渠道', 'warning');
                return;
            }

            const batchPrice = document.getElementById('batchPrice').value;
            const batchDailyCap = document.getElementById('batchDailyCap').value;
            const batchDailyClickCap = document.getElementById('batchDailyClickCap').value;

            let appliedCount = 0;
            selectedChannels.forEach(uuid => {
                if (batchPrice) {
                    document.getElementById(`price_${uuid}`).value = batchPrice;
                    appliedCount++;
                }
                if (batchDailyCap) {
                    document.getElementById(`dailyCap_${uuid}`).value = batchDailyCap;
                }
                if (batchDailyClickCap) {
                    document.getElementById(`dailyClickCap_${uuid}`).value = batchDailyClickCap;
                }
            });

            Utils.showToast(`已为 ${selectedChannels.length} 个渠道应用批量设置`, 'success');
            
            // 清空批量设置输入框
            document.getElementById('batchPrice').value = '';
            document.getElementById('batchDailyCap').value = '';
            document.getElementById('batchDailyClickCap').value = '';
        }

        // 获取选中的渠道UUID列表
        function getSelectedChannelUuids() {
            const checkboxes = document.querySelectorAll('.channel-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 全选功能
        function selectAllChannels() {
            const checkboxes = document.querySelectorAll('.channel-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('selectAll').checked = true;
        }

        // 清除所有选择
        function clearAllSelections() {
            const checkboxes = document.querySelectorAll('.channel-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
        }

        // 切换全选状态
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.channel-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // 更新全选状态
        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.channel-checkbox');
            const checkedBoxes = document.querySelectorAll('.channel-checkbox:checked');
            const selectAll = document.getElementById('selectAll');
            
            if (checkedBoxes.length === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            }
        }

        // 收集所有渠道设置数据
        function collectChannelSettings() {
            const selectedChannels = getSelectedChannels();
            const settings = [];
            
            selectedChannels.forEach(channel => {
                const setting = {
                    channelUuid: channel.uuid,
                    channelName: channel.name,
                    price: document.getElementById(`price_${channel.uuid}`).value,
                    dailyCap: document.getElementById(`dailyCap_${channel.uuid}`).value,
                    dailyClickCap: document.getElementById(`dailyClickCap_${channel.uuid}`).value,
                    deduction: document.getElementById(`deduction_${channel.uuid}`).value,
                    notes: document.getElementById(`notes_${channel.uuid}`).value,
                    status: document.getElementById(`status_${channel.uuid}`).value
                };
                
                // 验证必填字段
                if (!setting.price) {
                    throw new Error(`请为渠道 "${channel.name}" 设置Channel Price`);
                }
                
                settings.push(setting);
            });
            
            return settings;
        }

        // 提交渠道设置
        function submitChannelSettings() {
            try {
                const settings = collectChannelSettings();
                
                // 显示加载状态
                const submitBtn = document.querySelector('button[onclick="submitChannelSettings()"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
                
                // 模拟提交过程
                setTimeout(() => {
                    Utils.showToast('渠道对接设置提交成功！', 'success');
                    
                    // 显示设置摘要
                    setTimeout(() => {
                        showSettingsSummary(settings);
                    }, 1000);
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> 提交设置';
                }, 2000);
                
            } catch (error) {
                Utils.showToast(error.message, 'danger');
            }
        }

        // 显示设置摘要
        function showSettingsSummary(settings) {
            const summaryHtml = `
                <div class="modal fade" id="summaryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-check-circle text-success"></i>
                                    设置完成摘要
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">以下渠道已成功配置对接参数：</p>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>渠道名称</th>
                                                <th>价格</th>
                                                <th>日转化上限</th>
                                                <th>日点击上限</th>
                                                <th>扣量</th>
                                                <th>状态</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${settings.map(setting => `
                                                <tr>
                                                    <td>${setting.channelName}</td>
                                                    <td>$${setting.price}</td>
                                                    <td>${setting.dailyCap || '无限制'}</td>
                                                    <td>${setting.dailyClickCap || '无限制'}</td>
                                                    <td>${setting.deduction || '0'}%</td>
                                                    <td>
                                                        <span class="badge bg-${setting.status === 'active' ? 'success' : setting.status === 'paused' ? 'warning' : 'info'}">
                                                            ${setting.status === 'active' ? '激活' : setting.status === 'paused' ? '暂停' : '测试中'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                    完成
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', summaryHtml);
            const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
            modal.show();
            
            // 模态框关闭后清理
            document.getElementById('summaryModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            generateChannelSettings();
        });
    </script>
</body>
</html>