<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer List 管理</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>
    <script src="./geo-data.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .header { background: #409EFF; color: white; padding: 0 20px; height: 60px; line-height: 60px; }
        .main-container { padding: 20px; }
        .filter-section { margin-bottom: 20px; padding: 20px; background: #f5f7fa; border-radius: 8px; }
        .selected-tag { background: white !important; color: #f56c6c !important; border: 1px solid #f56c6c !important; }
        
        .el-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table__header-wrapper {
            width: 100% !important;
        }
        .el-table__header {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table__body-wrapper {
            width: 100% !important;
        }
        .el-table__body {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table th, .el-table td {
            white-space: nowrap !important;
            text-align: left !important;
            padding: 12px 0 !important;
            border-right: 1px solid #EBEEF5 !important;
        }
        .el-table th:first-child, .el-table td:first-child {
            padding-left: 16px !important;
        }
        .el-table th:last-child, .el-table td:last-child {
            padding-right: 16px !important;
            border-right: none !important;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e4e7ed;
        }
        
        .section-title {
            margin: 0 0 20px 0;
            color: #303133;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <!-- 顶部导航 -->
            <el-header class="header">
                <div style="display: flex; align-items: center; height: 100%;">
                    <el-menu mode="horizontal" :default-active="activeMenu" @select="handleMenuSelect" 
                             background-color="#409EFF" text-color="#fff" active-text-color="#fff"
                             style="border: none;">
                        <el-sub-menu index="offer">
                            <template #title>Offer</template>
                            <el-menu-item index="adv-user">Adv User</el-menu-item>
                            <el-menu-item index="package-list">Package List</el-menu-item>
                            <el-menu-item index="offer-list">Offer List</el-menu-item>
                        </el-sub-menu>
                        <el-menu-item index="channel">Channel</el-menu-item>
                    </el-menu>
                </div>
            </el-header>

            <!-- 主内容区 -->
            <el-main class="main-container">
                <div v-if="activeMenu === 'offer-list'">
                    <h2>Offer List 管理</h2>
                    
                    <!-- 筛选器 -->
                    <div class="filter-section">
                        <el-row :gutter="20">
                            <el-col :span="5">
                                <el-select
                                    v-model="selectedOffer"
                                    filterable
                                    remote
                                    reserve-keyword
                                    placeholder="搜索 Offer UUID"
                                    :remote-method="searchOffers"
                                    :loading="searchLoading"
                                    clearable
                                    @change="handleOfferFilter"
                                    style="width: 100%">
                                    <el-option
                                        v-for="offer in offerSearchResults"
                                        :key="offer.offerUuid"
                                        :label="offer.offerUuid"
                                        :value="offer.offerUuid">
                                    </el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="5">
                                <el-select
                                    v-model="selectedPackage"
                                    filterable
                                    remote
                                    reserve-keyword
                                    placeholder="搜索 Package Name"
                                    :remote-method="searchPackages"
                                    :loading="packageSearchLoading"
                                    clearable
                                    @change="handlePackageFilter"
                                    style="width: 100%">
                                    <el-option
                                        v-for="pkg in packageSearchResults"
                                        :key="pkg.packageName"
                                        :label="pkg.packageName"
                                        :value="pkg.packageName">
                                    </el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="5">
                                <el-select
                                    v-model="selectedUser"
                                    filterable
                                    remote
                                    reserve-keyword
                                    placeholder="搜索 Adv User"
                                    :remote-method="searchUsers"
                                    :loading="userSearchLoading"
                                    clearable
                                    @change="handleUserFilter"
                                    style="width: 100%">
                                    <el-option
                                        v-for="user in userSearchResults"
                                        :key="user.username"
                                        :label="user.username"
                                        :value="user.username">
                                    </el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="5">
                                <el-select
                                    v-model="selectedPricingModel"
                                    placeholder="Adv Pricing Model"
                                    clearable
                                    @change="handlePricingModelFilter"
                                    style="width: 100%">
                                    <el-option label="CPI" value="CPI"></el-option>
                                    <el-option label="CPE" value="CPE"></el-option>
                                    <el-option label="CPS" value="CPS"></el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="4">
                                <el-button type="primary" @click="showCreateDrawer = true">
                                    <el-icon><Plus /></el-icon>
                                    新建 Offer
                                </el-button>
                            </el-col>
                        </el-row>
                    </div>

                    <!-- 数据表格 -->
                    <el-table 
                        :data="paginatedOffers" 
                        v-loading="loading"
                        @sort-change="handleSortChange"
                        stripe
                        border
                        style="width: 100%">
                        <el-table-column prop="offerUuid" label="Offer UUID" sortable="custom" width="180" align="left"></el-table-column>
                        <el-table-column prop="packageName" label="Package Name" width="180" align="left"></el-table-column>
                        <el-table-column prop="advUser" label="Adv User" width="120" align="left"></el-table-column>
                        <el-table-column prop="advPricingModel" label="Adv Pricing Model" width="140" align="left"></el-table-column>
                        <el-table-column prop="advConversionPrice" label="Adv Conversion Price" width="160" align="left"></el-table-column>
                        <el-table-column prop="advConversionRealPrice" label="Adv Conversion Real Price" width="180" align="left"></el-table-column>
                        <el-table-column prop="offerPm" label="Offer PM" width="120" align="left"></el-table-column>
                        <el-table-column prop="bd" label="BD" width="100" align="left"></el-table-column>
                        <el-table-column prop="updateTime" label="更新时间" sortable="custom" width="160" align="left"></el-table-column>
                        <el-table-column label="操作" width="200" align="center">
                            <template #default="scope">
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <el-button size="small" @click="viewDetails(scope.row)">详情</el-button>
                                    <el-button size="small" @click="editOffer(scope.row)">编辑</el-button>
                                    <el-button size="small" type="danger" @click="deleteOffer(scope.row)">删除</el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>

                    <!-- 分页 -->
                    <div style="margin-top: 20px; text-align: right;">
                        <el-pagination
                            v-model:current-page="currentPage"
                            v-model:page-size="pageSize"
                            :page-sizes="[10, 20, 50]"
                            :total="filteredOffers.length"
                            layout="total, sizes, prev, pager, next, jumper"
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange">
                        </el-pagination>
                    </div>
                </div>

                <!-- 其他页面占位 -->
                <div v-else-if="activeMenu === 'adv-user'">
                    <h2>Adv User</h2>
                    <p><a href="./adv-user.html">进入 Adv User 管理</a></p>
                </div>
                <div v-else-if="activeMenu === 'package-list'">
                    <h2>Package List</h2>
                    <p><a href="./package-list.html">进入 Package List 管理</a></p>
                </div>
                <div v-else-if="activeMenu === 'channel'">
                    <h2>Channel</h2>
                    <p>功能开发中...</p>
                </div>
            </el-main>
        </el-container>

        <!-- 新建/编辑Offer抽屉 -->
        <el-drawer 
            v-model="showCreateDrawer" 
            :title="editingOffer ? '编辑 Offer' : '新建 Offer'"
            size="800px"
            direction="rtl">
            <div style="padding: 0 20px;">
                <el-form :model="offerForm" :rules="offerRules" ref="offerFormRef" label-width="160px">
                    <!-- 基础信息 -->
                    <div class="form-section">
                        <h3 class="section-title">📝 基础信息</h3>
                        <el-form-item label="Adv User" prop="advUser">
                            <el-select v-model="offerForm.advUser" filterable remote :remote-method="loadAdvUsers" 
                                       :disabled="editingOffer" placeholder="选择Adv User" style="width: 100%">
                                <el-option v-for="user in allUsers" :key="user.username" :label="user.username" :value="user.username" />
                            </el-select>
                        </el-form-item>
                        <el-form-item label="Package Name" prop="packageName">
                            <el-select v-model="offerForm.packageName" filterable remote :remote-method="loadPackages" 
                                       :disabled="editingOffer" placeholder="选择Package Name" style="width: 100%">
                                <el-option v-for="pkg in userPackages" :key="pkg.packageName" :label="pkg.packageName" :value="pkg.packageName" />
                            </el-select>
                        </el-form-item>
                        <el-form-item label="Offer UUID" prop="offerUuid">
                            <el-input v-model="offerForm.offerUuid" :disabled="editingOffer" placeholder="支持英文字母、数字、下划线、横杠"></el-input>
                        </el-form-item>
                        <el-form-item label="Optimization Goal" prop="optimizationGoal">
                            <el-select v-model="offerForm.optimizationGoal" placeholder="选择推广目标" style="width: 100%">
                                <el-option label="UA (拉新)" value="UA"></el-option>
                                <el-option label="RT (重定向)" value="RT"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="Notes" prop="notes">
                            <el-input v-model="offerForm.notes" type="textarea" :rows="2" placeholder="KPI要求附言"></el-input>
                        </el-form-item>
                    </div>

                    <!-- 结算信息 -->
                    <div class="form-section">
                        <h3 class="section-title">💰 结算信息</h3>
                        <el-form-item label="Adv Pricing Model" prop="advPricingModel">
                            <el-select v-model="offerForm.advPricingModel" :disabled="editingOffer" placeholder="选择结算模式" style="width: 100%">
                                <el-option label="CPI" value="CPI"></el-option>
                                <el-option label="CPE" value="CPE"></el-option>
                                <el-option label="CPS" value="CPS"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="Adv Conversion Price" prop="advConversionPrice">
                            <el-input v-model="offerForm.advConversionPrice" placeholder="记录用转化事件单价"></el-input>
                        </el-form-item>
                        <el-form-item label="Adv Conversion Real Price" prop="advConversionRealPrice">
                            <el-input v-model="offerForm.advConversionRealPrice" placeholder="真实转化事件单价"></el-input>
                        </el-form-item>
                    </div>

                    <!-- 预算信息 -->
                    <div class="form-section">
                        <h3 class="section-title">📈 预算信息</h3>
                        <el-form-item label="Adv Daily Cap" prop="advDailyCap">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <el-input 
                                    v-model="offerForm.advDailyCap" 
                                    placeholder="广告主约定预算值（1-5000）"
                                    :disabled="offerForm.advDailyCapOpen"
                                    type="number"
                                    :min="1"
                                    :max="5000"
                                    style="width: 280px;"></el-input>
                                <el-checkbox v-model="offerForm.advDailyCapOpen" @change="handleAdvDailyCapOpenChange">Open（不限制）</el-checkbox>
                            </div>
                        </el-form-item>
                        <el-form-item label="Daily Control Cap" prop="dailyControlCap">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <el-input 
                                    v-model="offerForm.dailyControlCap" 
                                    placeholder="运营控制预算值（1-5000）"
                                    :disabled="offerForm.dailyControlCapOpen"
                                    type="number"
                                    :min="1"
                                    :max="5000"
                                    style="width: 280px;"></el-input>
                                <el-checkbox v-model="offerForm.dailyControlCapOpen" @change="handleDailyControlCapOpenChange">Open（不限制）</el-checkbox>
                            </div>
                        </el-form-item>
                    </div>

                    <!-- 定向设置 -->
                    <div class="form-section">
                        <h3 class="section-title">🎯 定向设置</h3>
                        <el-form-item label="Platform" prop="platform">
                            <el-checkbox-group v-model="offerForm.platform">
                                <el-checkbox label="ios">iOS</el-checkbox>
                                <el-checkbox label="android">Android</el-checkbox>
                                <el-checkbox label="windows">Windows</el-checkbox>
                                <el-checkbox label="all">All</el-checkbox>
                                <el-checkbox label="others">Others</el-checkbox>
                            </el-checkbox-group>
                        </el-form-item>
                        <el-form-item label="Target Geo" prop="targetGeo">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <el-select 
                                    v-model="selectedCountries" 
                                    multiple
                                    filterable 
                                    placeholder="Select Countries" 
                                    @change="handleCountryChange"
                                    style="width: 200px;">
                                    <el-option 
                                        v-for="country in countryList" 
                                        :key="country" 
                                        :label="country" 
                                        :value="country">
                                    </el-option>
                                </el-select>
                                <el-select 
                                    v-model="selectedRegions" 
                                    multiple
                                    filterable 
                                    placeholder="Select Regions" 
                                    @change="handleRegionChange"
                                    :disabled="selectedCountries.length === 0"
                                    style="width: 220px;">
                                    <el-option 
                                        v-for="region in regionList" 
                                        :key="region" 
                                        :label="region" 
                                        :value="region">
                                    </el-option>
                                </el-select>
                                <el-select 
                                    v-model="selectedCities" 
                                    multiple
                                    filterable 
                                    placeholder="Select Cities" 
                                    @change="handleCityChange"
                                    :disabled="selectedRegions.length === 0"
                                    style="width: 200px;">
                                    <el-option 
                                        v-for="city in cityList" 
                                        :key="city" 
                                        :label="city" 
                                        :value="city">
                                    </el-option>
                                </el-select>
                                <el-button @click="addTargetGeo" :disabled="selectedCities.length === 0" size="small">Add</el-button>
                            </div>
                            <div style="margin-top: 10px;" v-if="offerForm.targetGeoList && offerForm.targetGeoList.length > 0">
                                <el-tag 
                                    v-for="(geo, index) in offerForm.targetGeoList" 
                                    :key="index" 
                                    closable 
                                    @close="removeTargetGeo(index)"
                                    style="margin-right: 8px; margin-bottom: 8px;">
                                    {{ geo }}
                                </el-tag>
                            </div>
                            <el-input 
                                v-model="offerForm.targetGeo" 
                                type="hidden">
                            </el-input>
                        </el-form-item>
                        <el-form-item label="Network" prop="network">
                            <el-checkbox-group v-model="offerForm.network">
                                <el-checkbox label="wifi">WiFi</el-checkbox>
                                <el-checkbox label="2G">2G</el-checkbox>
                                <el-checkbox label="3G">3G</el-checkbox>
                                <el-checkbox label="4G">4G</el-checkbox>
                            </el-checkbox-group>
                        </el-form-item>
                    </div>

                    <!-- 运营设置 -->
                    <div class="form-section">
                        <h3 class="section-title">👥 运营设置</h3>
                        <el-form-item label="Offer PM" prop="offerPm">
                            <el-select v-model="offerForm.offerPm" placeholder="选择Offer PM" style="width: 100%">
                                <el-option v-for="pm in advPmList" :key="pm" :label="pm" :value="pm"></el-option>
                            </el-select>
                        </el-form-item>
                    </div>

                    <!-- Tracking link与归因 -->
                    <div class="form-section">
                        <h3 class="section-title">🔗 Tracking link与归因</h3>
                        <el-form-item label="Impression Tracking" prop="impressionTracking">
                            <el-input v-model="offerForm.impressionTracking" placeholder="曝光监测链接"></el-input>
                        </el-form-item>
                        <el-form-item label="Click Tracking" prop="clickTracking">
                            <el-input v-model="offerForm.clickTracking" placeholder="点击监测链接"></el-input>
                        </el-form-item>
                        <el-form-item label="Third Party" prop="thirdParty">
                            <!-- 第三方监测平台选择 - 包含10个选项 -->
                            <el-select v-model="offerForm.thirdParty" placeholder="选择监测平台" style="width: 100%">
                                <el-option label="S2S (自归因)" value="S2S"></el-option>
                                <el-option label="Appsflyer" value="Appsflyer"></el-option>
                                <el-option label="Adjust" value="Adjust"></el-option>
                                <el-option label="Singular" value="Singular"></el-option>
                                <el-option label="Branch" value="Branch"></el-option>
                                <el-option label="Kochava" value="Kochava"></el-option>
                                <el-option label="Tenjin" value="Tenjin"></el-option>
                                <el-option label="Tune" value="Tune"></el-option>
                                <el-option label="Apsalar" value="Apsalar"></el-option>
                                <el-option label="Attribution" value="Attribution"></el-option>
                            </el-select>
                        </el-form-item>
                    </div>
                </el-form>
            </div>
            <template #footer>
                <div style="text-align: right; padding: 20px 0;">
                    <el-button @click="showCreateDrawer = false">取消</el-button>
                    <el-button type="primary" @click="saveOffer">保存</el-button>
                </div>
            </template>
        </el-drawer>

        <!-- 详情查看弹窗 -->
        <el-dialog v-model="showDetailDialog" title="Offer 详情" width="800px">
            <el-descriptions :column="2" border v-if="currentOffer">
                <el-descriptions-item label="Offer UUID" :span="2">{{ currentOffer.offerUuid }}</el-descriptions-item>
                <el-descriptions-item label="Adv User">{{ currentOffer.advUser }}</el-descriptions-item>
                <el-descriptions-item label="Package Name">{{ currentOffer.packageName }}</el-descriptions-item>
                <el-descriptions-item label="Optimization Goal">{{ currentOffer.optimizationGoal }}</el-descriptions-item>
                <el-descriptions-item label="Adv Pricing Model">{{ currentOffer.advPricingModel }}</el-descriptions-item>
                <el-descriptions-item label="Adv Conversion Price">{{ currentOffer.advConversionPrice }}</el-descriptions-item>
                <el-descriptions-item label="Adv Conversion Real Price">{{ currentOffer.advConversionRealPrice }}</el-descriptions-item>
                <el-descriptions-item label="Platform">{{ Array.isArray(currentOffer.platform) ? currentOffer.platform.join(', ') : currentOffer.platform }}</el-descriptions-item>
                <el-descriptions-item label="Target Geo">{{ currentOffer.targetGeo }}</el-descriptions-item>
                <el-descriptions-item label="Offer PM">{{ currentOffer.offerPm }}</el-descriptions-item>
                <el-descriptions-item label="BD">{{ currentOffer.bd }}</el-descriptions-item>
                <el-descriptions-item label="Third Party">{{ currentOffer.thirdParty }}</el-descriptions-item>
                <el-descriptions-item label="Notes" :span="2">{{ currentOffer.notes }}</el-descriptions-item>
                <el-descriptions-item label="更新时间" :span="2">{{ currentOffer.updateTime }}</el-descriptions-item>
            </el-descriptions>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                // 响应式数据
                const activeMenu = ref('offer-list');
                const loading = ref(false);
                const searchLoading = ref(false);
                const packageSearchLoading = ref(false);
                const userSearchLoading = ref(false);
                const showCreateDrawer = ref(false);
                const showDetailDialog = ref(false);
                const editingOffer = ref(null);
                const currentOffer = ref(null);
                
                const selectedOffer = ref('');
                const selectedPackage = ref('');
                const selectedUser = ref('');
                const selectedPricingModel = ref('');
                
                const offerSearchResults = ref([]);
                const packageSearchResults = ref([]);
                const userSearchResults = ref([]);
                
                const currentPage = ref(1);
                const pageSize = ref(20);
                const sortField = ref('updateTime');
                const sortOrder = ref('desc');

                // 表单数据
                const offerForm = ref({
                    advUser: '',
                    packageName: '',
                    offerUuid: '',
                    optimizationGoal: '',
                    notes: '',
                    advPricingModel: '',
                    advConversionPrice: '',
                    advConversionRealPrice: '',
                    advDailyCap: '',
                    advDailyCapOpen: false,
                    dailyControlCap: '',
                    dailyControlCapOpen: false,
                    platform: [],
                    targetGeo: '',
                    targetGeoList: [],
                    network: [],
                    offerPm: '',
                    impressionTracking: '',
                    clickTracking: '',
                    thirdParty: '',
                    bd: ''
                });

                // 数据
                const offers = ref([]);
                const allUsers = ref([]);
                const allPackages = ref([]);
                const userPackages = ref([]);


                // 表单验证规则
                const offerRules = {
                    advUser: [{ required: true, message: '请选择Adv User', trigger: 'change' }],
                    packageName: [{ required: true, message: '请选择Package Name', trigger: 'change' }],
                    offerUuid: [
                        { required: true, message: '请输入Offer UUID', trigger: 'blur' },
                        { pattern: /^[a-zA-Z0-9_-]+$/, message: '只支持英文字母、数字、下划线、横杠', trigger: 'blur' }
                    ],
                    optimizationGoal: [{ required: true, message: '请选择推广目标', trigger: 'change' }],
                    advPricingModel: [{ required: true, message: '请选择结算模式', trigger: 'change' }],
                    advConversionPrice: [{ required: true, message: '请输入转化事件单价', trigger: 'blur' }],
                    advConversionRealPrice: [{ required: true, message: '请输入真实转化事件单价', trigger: 'blur' }],
                    offerPm: [{ required: true, message: '请选择Offer PM', trigger: 'change' }]
                };

                // PM选项列表（与Adv User保持一致）
                const advPmList = ref(['刘一', '陈二', '杨三', '黄四', '朱五', '林六', '郭七', '何八']);

                // 地区选择相关数据
                const selectedCountries = ref([]);
                const selectedRegions = ref([]);
                const selectedCities = ref([]);
                const countryList = ref([]);
                const regionList = ref([]);
                const cityList = ref([]);

                // 计算属性

                const filteredOffers = computed(() => {
                    let result = offers.value;
                    
                    if (selectedOffer.value) {
                        result = result.filter(offer => offer.offerUuid.includes(selectedOffer.value));
                    }
                    if (selectedPackage.value) {
                        result = result.filter(offer => offer.packageName.includes(selectedPackage.value));
                    }
                    if (selectedUser.value) {
                        result = result.filter(offer => offer.advUser === selectedUser.value);
                    }
                    if (selectedPricingModel.value) {
                        result = result.filter(offer => offer.advPricingModel === selectedPricingModel.value);
                    }
                    
                    // 排序
                    result.sort((a, b) => {
                        const aVal = a[sortField.value];
                        const bVal = b[sortField.value];
                        if (sortOrder.value === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                    
                    return result;
                });

                const paginatedOffers = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filteredOffers.value.slice(start, end);
                });

                // 监听Adv User变化，加载对应的Package
                watch(() => offerForm.value.advUser, (newUser) => {
                    if (newUser) {
                        userPackages.value = allPackages.value.filter(pkg => pkg.username === newUser);
                        // 自动设置BD
                        const user = allUsers.value.find(u => u.username === newUser);
                        if (user) {
                            offerForm.value.bd = user.bd;
                        }
                    } else {
                        userPackages.value = [];
                        offerForm.value.bd = '';
                    }
                });

                // 方法
                const handleMenuSelect = (key) => {
                    activeMenu.value = key;
                    if (key === 'adv-user') {
                        window.location.href = './adv-user.html';
                    } else if (key === 'package-list') {
                        window.location.href = './package-list.html';
                    }
                };

                const searchOffers = (query) => {
                    if (query) {
                        searchLoading.value = true;
                        setTimeout(() => {
                            offerSearchResults.value = offers.value.filter(offer => 
                                offer.offerUuid.toLowerCase().includes(query.toLowerCase())
                            ).slice(0, 10);
                            searchLoading.value = false;
                        }, 200);
                    } else {
                        offerSearchResults.value = [];
                    }
                };

                const searchPackages = (query) => {
                    if (query) {
                        packageSearchLoading.value = true;
                        setTimeout(() => {
                            packageSearchResults.value = allPackages.value.filter(pkg => 
                                pkg.packageName.toLowerCase().includes(query.toLowerCase())
                            ).slice(0, 10);
                            packageSearchLoading.value = false;
                        }, 200);
                    } else {
                        packageSearchResults.value = [];
                    }
                };

                const searchUsers = (query) => {
                    if (query) {
                        userSearchLoading.value = true;
                        setTimeout(() => {
                            userSearchResults.value = allUsers.value.filter(user => 
                                user.username.toLowerCase().includes(query.toLowerCase())
                            ).slice(0, 10);
                            userSearchLoading.value = false;
                        }, 200);
                    } else {
                        userSearchResults.value = [];
                    }
                };

                const handleOfferFilter = (value) => {
                    selectedOffer.value = value;
                    currentPage.value = 1;
                };

                const handlePackageFilter = (value) => {
                    selectedPackage.value = value;
                    currentPage.value = 1;
                };

                const handleUserFilter = (value) => {
                    selectedUser.value = value;
                    currentPage.value = 1;
                };

                const handlePricingModelFilter = (value) => {
                    selectedPricingModel.value = value;
                    currentPage.value = 1;
                };

                const handleSortChange = ({ prop, order }) => {
                    sortField.value = prop;
                    sortOrder.value = order === 'ascending' ? 'asc' : 'desc';
                };

                const handleSizeChange = (size) => {
                    pageSize.value = size;
                    currentPage.value = 1;
                };

                const handleCurrentChange = (page) => {
                    currentPage.value = page;
                };

                const viewDetails = (offer) => {
                    currentOffer.value = offer;
                    showDetailDialog.value = true;
                };

                const editOffer = (offer) => {
                    editingOffer.value = offer;
                    offerForm.value = { ...offer };
                    // 加载对应用户的Package
                    userPackages.value = allPackages.value.filter(pkg => pkg.username === offer.advUser);
                    showCreateDrawer.value = true;
                };

                const deleteOffer = async (offer) => {
                    try {
                        await ElMessageBox.confirm('确定要删除这个Offer吗？', '确认删除', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const index = offers.value.findIndex(o => o.offerUuid === offer.offerUuid);
                        if (index > -1) {
                            offers.value.splice(index, 1);
                            saveToStorage();
                            ElMessage.success('删除成功');
                        }
                    } catch {
                        // 用户取消删除
                    }
                };

                const loadAdvUsers = () => {
                    // 已在watch中处理
                };

                const loadPackages = () => {
                    // 已在watch中处理
                };

                const handleAdvDailyCapOpenChange = (value) => {
                    if (value) {
                        offerForm.value.advDailyCap = '';
                    }
                };

                const handleDailyControlCapOpenChange = (value) => {
                    if (value) {
                        offerForm.value.dailyControlCap = '';
                    }
                };

                // 地区选择相关方法
                const handleCountryChange = (countries) => {
                    selectedRegions.value = [];
                    selectedCities.value = [];
                    const regions = new Set();
                    countries.forEach(country => {
                        if (window.GEO_DATA[country]) {
                            Object.keys(window.GEO_DATA[country]).forEach(region => {
                                regions.add(region);
                            });
                        }
                    });
                    regionList.value = Array.from(regions);
                    cityList.value = [];
                };

                const handleRegionChange = (regions) => {
                    selectedCities.value = [];
                    const cities = new Set();
                    selectedCountries.value.forEach(country => {
                        regions.forEach(region => {
                            if (window.GEO_DATA[country] && window.GEO_DATA[country][region]) {
                                window.GEO_DATA[country][region].forEach(city => {
                                    cities.add(city);
                                });
                            }
                        });
                    });
                    cityList.value = Array.from(cities);
                };

                const handleCityChange = (cities) => {
                    // 城市选择后的处理
                };

                const addTargetGeo = () => {
                    selectedCountries.value.forEach(country => {
                        selectedRegions.value.forEach(region => {
                            selectedCities.value.forEach(city => {
                                const geoString = `${country} > ${region} > ${city}`;
                                if (!offerForm.value.targetGeoList.includes(geoString)) {
                                    offerForm.value.targetGeoList.push(geoString);
                                }
                            });
                        });
                    });
                    updateTargetGeoString();
                    // 清空选择
                    selectedCountries.value = [];
                    selectedRegions.value = [];
                    selectedCities.value = [];
                    regionList.value = [];
                    cityList.value = [];
                };

                const removeTargetGeo = (index) => {
                    offerForm.value.targetGeoList.splice(index, 1);
                    updateTargetGeoString();
                };

                const updateTargetGeoString = () => {
                    offerForm.value.targetGeo = offerForm.value.targetGeoList.join('; ');
                };

                const initGeoData = () => {
                    if (window.GEO_DATA) {
                        countryList.value = Object.keys(window.GEO_DATA);
                    }
                };

                const saveOffer = async () => {
                    if (!offerForm.value.advUser || !offerForm.value.packageName || !offerForm.value.offerUuid) {
                        ElMessage.error('请填写完整信息');
                        return;
                    }

                    const now = new Date().toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(/\//g, '-');

                    if (editingOffer.value) {
                        // 编辑
                        const index = offers.value.findIndex(o => o.offerUuid === editingOffer.value.offerUuid);
                        if (index > -1) {
                            offers.value[index] = {
                                ...offerForm.value,
                                updateTime: now
                            };
                        }
                        ElMessage.success('更新成功');
                    } else {
                        // 新建
                        if (offers.value.some(o => o.offerUuid === offerForm.value.offerUuid)) {
                            ElMessage.error('Offer UUID已存在');
                            return;
                        }
                        
                        offers.value.push({
                            ...offerForm.value,
                            updateTime: now
                        });
                        ElMessage.success('创建成功');
                    }

                    saveToStorage();
                    showCreateDrawer.value = false;
                    editingOffer.value = null;
                    offerForm.value = {
                        advUser: '',
                        packageName: '',
                        offerUuid: '',
                        optimizationGoal: '',
                        notes: '',
                        advPricingModel: '',
                        advConversionPrice: '',
                        advConversionRealPrice: '',
                        advDailyCap: '',
                        advDailyCapOpen: false,
                        dailyControlCap: '',
                        dailyControlCapOpen: false,
                        platform: [],
                        targetGeo: '',
                        targetGeoList: [],
                        network: [],
                        offerPm: '',
                        impressionTracking: '',
                        clickTracking: '',
                        thirdParty: '',
                        bd: ''
                    };
                };

                const saveToStorage = () => {
                    localStorage.setItem('offers', JSON.stringify(offers.value));
                };

                const loadFromStorage = () => {
                    try {
                        // 加载用户数据
                        const storedUsers = localStorage.getItem('advUsers');
                        if (storedUsers) {
                            allUsers.value = JSON.parse(storedUsers);
                        }

                        // 加载包数据
                        const storedPackages = localStorage.getItem('packages');
                        if (storedPackages) {
                            allPackages.value = JSON.parse(storedPackages);
                        }

                        // 加载Offer数据
                        const storedOffers = localStorage.getItem('offers');
                        if (storedOffers) {
                            offers.value = JSON.parse(storedOffers);
                        } else {
                            initSampleData();
                        }
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        initSampleData();
                    }
                };

                const initSampleData = () => {
                    offers.value = [
                        {
                            offerUuid: 'offer_demo_001',
                            advUser: 'demo_user_1',
                            packageName: 'com.example.demo',
                            optimizationGoal: 'UA',
                            notes: 'Demo offer for testing',
                            advPricingModel: 'CPI',
                            advConversionPrice: '2.50',
                            advConversionRealPrice: '3.00',
                            advDailyCap: '1000',
                            advDailyCapOpen: false,
                            dailyControlCap: '800',
                            dailyControlCapOpen: false,
                            platform: ['android'],
                            targetGeo: 'United States (US) > California (CA) > Los Angeles',
                            targetGeoList: ['United States (US) > California (CA) > Los Angeles'],
                            network: ['wifi'],
                            offerPm: 'Alice Chen',
                            bd: '张三',
                            impressionTracking: 'https://track.example.com/imp',
                            clickTracking: 'https://track.example.com/click',
                            thirdParty: 'Appsflyer',
                            updateTime: '2025-01-15 10:30:25'
                        },
                        {
                            offerUuid: 'offer_test_002',
                            advUser: 'test_advertiser',
                            packageName: 'id1580749519',
                            optimizationGoal: 'RT',
                            notes: 'iOS retargeting campaign',
                            advPricingModel: 'CPE',
                            advConversionPrice: '1.80',
                            advConversionRealPrice: '2.20',
                            advDailyCap: '500',
                            advDailyCapOpen: false,
                            dailyControlCap: '400',
                            dailyControlCapOpen: false,
                            platform: ['ios'],
                            targetGeo: 'United Kingdom (UK) > England (ENG) > London',
                            targetGeoList: ['United Kingdom (UK) > England (ENG) > London'],
                            network: ['4G'],
                            offerPm: 'Bob Wang',
                            bd: '李四',
                            impressionTracking: 'https://track.example.com/imp2',
                            clickTracking: 'https://track.example.com/click2',
                            thirdParty: 'S2S',
                            updateTime: '2025-01-14 16:45:12'
                        },
                        {
                            offerUuid: 'offer_sample_003',
                            advUser: 'sample_client',
                            packageName: 'net.sample.app',
                            optimizationGoal: 'UA',
                            notes: 'Social app user acquisition',
                            advPricingModel: 'CPS',
                            advConversionPrice: '5.00',
                            advConversionRealPrice: '6.50',
                            advDailyCap: '2000',
                            advDailyCapOpen: false,
                            dailyControlCap: '1800',
                            dailyControlCapOpen: false,
                            platform: ['all'],
                            targetGeo: 'Canada (CA) > Ontario (ON) > Toronto',
                            targetGeoList: ['Canada (CA) > Ontario (ON) > Toronto'],
                            network: ['wifi'],
                            offerPm: 'Carol Li',
                            bd: '王五',
                            impressionTracking: 'https://track.example.com/imp3',
                            clickTracking: 'https://track.example.com/click3',
                            thirdParty: 'Adjust',
                            updateTime: '2025-01-13 09:15:33'
                        },
                        {
                            offerUuid: 'offer_mobile_004',
                            advUser: 'mobile_app_user',
                            packageName: 'id987654321',
                            optimizationGoal: 'UA',
                            notes: 'Utility app promotion',
                            advPricingModel: 'CPI',
                            advConversionPrice: '1.20',
                            advConversionRealPrice: '1.50',
                            advDailyCap: '300',
                            advDailyCapOpen: false,
                            dailyControlCap: '250',
                            dailyControlCapOpen: false,
                            platform: ['ios'],
                            targetGeo: 'Australia (AU) > New South Wales (NSW) > Sydney',
                            targetGeoList: ['Australia (AU) > New South Wales (NSW) > Sydney'],
                            network: ['3G'],
                            offerPm: 'David Zhang',
                            bd: '赵六',
                            impressionTracking: 'https://track.example.com/imp4',
                            clickTracking: 'https://track.example.com/click4',
                            thirdParty: 'Singular',
                            updateTime: '2025-01-12 14:20:18'
                        },
                        {
                            offerUuid: 'offer_web_005',
                            advUser: 'web_platform_client',
                            packageName: 'com.webplatform.client',
                            optimizationGoal: 'RT',
                            notes: 'Business app retargeting',
                            advPricingModel: 'CPE',
                            advConversionPrice: '3.80',
                            advConversionRealPrice: '4.20',
                            advDailyCap: '800',
                            advDailyCapOpen: false,
                            dailyControlCap: '700',
                            dailyControlCapOpen: false,
                            platform: ['android'],
                            targetGeo: 'Germany (DE) > Bavaria (BY) > Munich',
                            targetGeoList: ['Germany (DE) > Bavaria (BY) > Munich'],
                            network: ['wifi'],
                            offerPm: 'Eva Liu',
                            bd: '钱七',
                            impressionTracking: 'https://track.example.com/imp5',
                            clickTracking: 'https://track.example.com/click5',
                            thirdParty: 'Appsflyer',
                            updateTime: '2025-01-11 09:45:30'
                        }
                    ];
                    saveToStorage();
                };

                // 生命周期
                onMounted(() => {
                    loadFromStorage();
                    initGeoData();
                });

                return {
                    activeMenu,
                    loading,
                    searchLoading,
                    packageSearchLoading,
                    userSearchLoading,
                    showCreateDrawer,
                    showDetailDialog,
                    editingOffer,
                    currentOffer,
                    selectedOffer,
                    selectedPackage,
                    selectedUser,
                    selectedPricingModel,
                    offerSearchResults,
                    packageSearchResults,
                    userSearchResults,
                    currentPage,
                    pageSize,
                    offerForm,
                    offers,
                    allUsers,
                    allPackages,
                    userPackages,
                    advPmList,
                    offerRules,
                    filteredOffers,
                    paginatedOffers,
                    handleMenuSelect,
                    searchOffers,
                    searchPackages,
                    searchUsers,
                    handleOfferFilter,
                    handlePackageFilter,
                    handleUserFilter,
                    handlePricingModelFilter,
                    handleSortChange,
                    handleSizeChange,
                    handleCurrentChange,
                    viewDetails,
                    editOffer,
                    deleteOffer,
                    loadAdvUsers,
                    loadPackages,
                    saveOffer,
                    handleAdvDailyCapOpenChange,
                    handleDailyControlCapOpenChange,
                    selectedCountries,
                    selectedRegions,
                    selectedCities,
                    countryList,
                    regionList,
                    cityList,
                    handleCountryChange,
                    handleRegionChange,
                    handleCityChange,
                    addTargetGeo,
                    removeTargetGeo
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>