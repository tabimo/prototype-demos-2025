<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>渠道预设管理 - S2S渠道对接系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-arrow-left"></i> S2S系统
            </a>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="index.html" class="text-white-50">首页</a></li>
                    <li class="breadcrumb-item active text-white">渠道预设管理</li>
                </ol>
            </nav>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 左侧：渠道管理 -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-database text-primary"></i>
                                渠道库管理
                            </h5>
                            <button class="btn btn-success" onclick="showAddChannelModal()">
                                <i class="fas fa-plus"></i> 添加渠道
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选区域 -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-select" id="filterThirdParty" onchange="filterChannels()">
                                    <option value="">所有Third Party</option>
                                    <option value="Appsflyer">Appsflyer</option>
                                    <option value="Adjust">Adjust</option>
                                    <option value="Singular">Singular</option>
                                    <option value="Kochava">Kochava</option>
                                    <option value="Branch">Branch</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="filterChannel" 
                                       placeholder="搜索Channel UUID" onkeyup="filterChannels()">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> 清除筛选
                                </button>
                            </div>
                        </div>

                        <!-- 渠道列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Third Party</th>
                                        <th>Channel UUID</th>
                                        <th>状态</th>
                                        <th width="120">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="channelTableBody">
                                    <!-- 渠道数据将在这里动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：快捷模板管理 -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-tags text-success"></i>
                                快捷模板
                            </h5>
                            <button class="btn btn-success btn-sm" onclick="showAddTemplateModal()">
                                <i class="fas fa-plus"></i> 新建
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="templateList">
                            <!-- 模板列表将在这里动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑渠道模态框 -->
    <div class="modal fade" id="channelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="channelModalTitle">添加渠道</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="channelForm">
                        <input type="hidden" id="channelId" value="">
                        <div class="mb-3">
                            <label class="form-label">Third Party <span class="text-danger">*</span></label>
                            <select class="form-select" id="thirdParty" required>
                                <option value="">请选择Third Party</option>
                                <option value="Appsflyer">Appsflyer</option>
                                <option value="Adjust">Adjust</option>
                                <option value="Singular">Singular</option>
                                <option value="Kochava">Kochava</option>
                                <option value="Branch">Branch</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Channel UUID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="channelUuid" required
                                   placeholder="如：abc、alphamobi、ntd_dsp等">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveChannel()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模板模态框 -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle">新建快捷模板</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <input type="hidden" id="templateId" value="">
                        <div class="mb-3">
                            <label class="form-label">模板名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="templateName" required
                                   placeholder="如：主流社媒、搜索引擎、DSP平台等">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">选择渠道 <span class="text-danger">*</span></label>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div id="channelCheckboxList">
                                    <!-- 渠道复选框列表将在这里生成 -->
                                </div>
                            </div>
                            <small class="text-muted">至少选择一个渠道</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveTemplate()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
        // 模拟数据
        let channelData = [
            {id: 1, thirdParty: 'Appsflyer', channelUuid: 'abc', status: 'active'},
            {id: 2, thirdParty: 'Appsflyer', channelUuid: 'abcd', status: 'active'},
            {id: 3, thirdParty: 'Adjust', channelUuid: 'alphamobi', status: 'active'},
            {id: 4, thirdParty: 'Adjust', channelUuid: 'ntd_dsp', status: 'active'},
            {id: 5, thirdParty: 'Singular', channelUuid: 'nx_dsp', status: 'active'},
            {id: 6, thirdParty: 'Kochava', channelUuid: 'facebook_ads', status: 'active'},
            {id: 7, thirdParty: 'Branch', channelUuid: 'google_ads', status: 'active'},
            {id: 8, thirdParty: 'Appsflyer', channelUuid: 'tiktok_ads', status: 'active'},
            {id: 9, thirdParty: 'Adjust', channelUuid: 'snapchat_ads', status: 'active'},
            {id: 10, thirdParty: 'Singular', channelUuid: 'twitter_ads', status: 'active'}
        ];

        let templateData = [
            {id: 1, name: '主流社媒', channels: ['facebook_ads', 'tiktok_ads', 'snapchat_ads', 'twitter_ads']},
            {id: 2, name: '搜索引擎', channels: ['google_ads']},
            {id: 3, name: 'DSP平台', channels: ['ntd_dsp', 'nx_dsp']},
            {id: 4, name: '测试渠道', channels: ['abc', 'abcd']},
            {id: 5, name: '高质量渠道', channels: ['alphamobi', 'facebook_ads', 'google_ads']}
        ];

        let filteredChannels = [...channelData];
        let editingChannelId = null;
        let editingTemplateId = null;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            renderChannelTable();
            renderTemplateList();
        });

        // 渲染渠道表格
        function renderChannelTable() {
            const tbody = document.getElementById('channelTableBody');
            tbody.innerHTML = filteredChannels.map(channel => `
                <tr>
                    <td><span class="badge bg-primary">${channel.thirdParty}</span></td>
                    <td><code>${channel.channelUuid}</code></td>
                    <td>
                        <span class="badge bg-${channel.status === 'active' ? 'success' : 'secondary'}">
                            ${channel.status === 'active' ? '启用' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editChannel(${channel.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteChannel(${channel.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 渲染模板列表
        function renderTemplateList() {
            const container = document.getElementById('templateList');
            container.innerHTML = templateData.map(template => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">${template.name}</h6>
                                <small class="text-muted">${template.channels.length}个渠道</small>
                                <div class="mt-2">
                                    ${template.channels.slice(0, 3).map(ch => `<span class="badge bg-light text-dark me-1">${ch}</span>`).join('')}
                                    ${template.channels.length > 3 ? `<span class="text-muted">+${template.channels.length - 3}</span>` : ''}
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editTemplate(${template.id})">
                                        <i class="fas fa-edit"></i> 编辑
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTemplate(${template.id})">
                                        <i class="fas fa-trash"></i> 删除
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 筛选渠道
        function filterChannels() {
            const thirdPartyFilter = document.getElementById('filterThirdParty').value;
            const channelFilter = document.getElementById('filterChannel').value.toLowerCase();

            filteredChannels = channelData.filter(channel => {
                const thirdPartyMatch = !thirdPartyFilter || channel.thirdParty === thirdPartyFilter;
                const channelMatch = !channelFilter || channel.channelUuid.toLowerCase().includes(channelFilter);
                return thirdPartyMatch && channelMatch;
            });

            renderChannelTable();
        }

        // 清除筛选
        function clearFilters() {
            document.getElementById('filterThirdParty').value = '';
            document.getElementById('filterChannel').value = '';
            filteredChannels = [...channelData];
            renderChannelTable();
        }

        // 显示添加渠道模态框
        function showAddChannelModal() {
            editingChannelId = null;
            document.getElementById('channelModalTitle').textContent = '添加渠道';
            document.getElementById('channelForm').reset();
            new bootstrap.Modal(document.getElementById('channelModal')).show();
        }

        // 编辑渠道
        function editChannel(id) {
            const channel = channelData.find(c => c.id === id);
            if (!channel) return;

            editingChannelId = id;
            document.getElementById('channelModalTitle').textContent = '编辑渠道';
            document.getElementById('channelId').value = channel.id;
            document.getElementById('thirdParty').value = channel.thirdParty;
            document.getElementById('channelUuid').value = channel.channelUuid;
            new bootstrap.Modal(document.getElementById('channelModal')).show();
        }

        // 保存渠道
        function saveChannel() {
            const form = document.getElementById('channelForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const thirdParty = document.getElementById('thirdParty').value;
            const channelUuid = document.getElementById('channelUuid').value;

            // 检查重复
            const exists = channelData.some(c => 
                c.channelUuid === channelUuid && c.id !== editingChannelId
            );
            if (exists) {
                Utils.showToast('Channel UUID已存在', 'warning');
                return;
            }

            if (editingChannelId) {
                // 编辑
                const index = channelData.findIndex(c => c.id === editingChannelId);
                channelData[index] = {...channelData[index], thirdParty, channelUuid};
                Utils.showToast('渠道更新成功', 'success');
            } else {
                // 新增
                const newChannel = {
                    id: Math.max(...channelData.map(c => c.id)) + 1,
                    thirdParty,
                    channelUuid,
                    status: 'active'
                };
                channelData.push(newChannel);
                Utils.showToast('渠道添加成功', 'success');
            }

            filterChannels();
            bootstrap.Modal.getInstance(document.getElementById('channelModal')).hide();
        }

        // 删除渠道
        function deleteChannel(id) {
            if (confirm('确认删除此渠道？')) {
                channelData = channelData.filter(c => c.id !== id);
                filterChannels();
                Utils.showToast('渠道删除成功', 'success');
            }
        }

        // 显示添加模板模态框
        function showAddTemplateModal() {
            editingTemplateId = null;
            document.getElementById('templateModalTitle').textContent = '新建快捷模板';
            document.getElementById('templateForm').reset();
            generateChannelCheckboxList();
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        // 生成渠道复选框列表
        function generateChannelCheckboxList() {
            const container = document.getElementById('channelCheckboxList');
            const groupedChannels = {};
            
            channelData.forEach(channel => {
                if (!groupedChannels[channel.thirdParty]) {
                    groupedChannels[channel.thirdParty] = [];
                }
                groupedChannels[channel.thirdParty].push(channel);
            });

            container.innerHTML = Object.keys(groupedChannels).map(thirdParty => `
                <div class="mb-3">
                    <h6 class="text-primary">${thirdParty}</h6>
                    ${groupedChannels[thirdParty].map(channel => `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${channel.channelUuid}" 
                                   id="channel_${channel.id}">
                            <label class="form-check-label" for="channel_${channel.id}">
                                ${channel.channelUuid}
                            </label>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // 编辑模板
        function editTemplate(id) {
            const template = templateData.find(t => t.id === id);
            if (!template) return;

            editingTemplateId = id;
            document.getElementById('templateModalTitle').textContent = '编辑快捷模板';
            document.getElementById('templateId').value = template.id;
            document.getElementById('templateName').value = template.name;
            
            generateChannelCheckboxList();
            
            // 选中已有的渠道
            template.channels.forEach(channelUuid => {
                const checkbox = document.querySelector(`input[value="${channelUuid}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        // 保存模板
        function saveTemplate() {
            const form = document.getElementById('templateForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const templateName = document.getElementById('templateName').value;
            const selectedChannels = Array.from(document.querySelectorAll('#channelCheckboxList input:checked'))
                .map(cb => cb.value);

            if (selectedChannels.length === 0) {
                Utils.showToast('请至少选择一个渠道', 'warning');
                return;
            }

            if (editingTemplateId) {
                // 编辑
                const index = templateData.findIndex(t => t.id === editingTemplateId);
                templateData[index] = {...templateData[index], name: templateName, channels: selectedChannels};
                Utils.showToast('模板更新成功', 'success');
            } else {
                // 新增
                const newTemplate = {
                    id: Math.max(...templateData.map(t => t.id)) + 1,
                    name: templateName,
                    channels: selectedChannels
                };
                templateData.push(newTemplate);
                Utils.showToast('模板创建成功', 'success');
            }

            renderTemplateList();
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
        }

        // 删除模板
        function deleteTemplate(id) {
            if (confirm('确认删除此模板？')) {
                templateData = templateData.filter(t => t.id !== id);
                renderTemplateList();
                Utils.showToast('模板删除成功', 'success');
            }
        }
    </script>
</body>
</html>