<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广告产品管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .header { background: #409EFF; color: white; padding: 0 20px; height: 60px; line-height: 60px; }
        .main-container { padding: 20px; }
        .filter-section { margin-bottom: 20px; padding: 20px; background: #f5f7fa; border-radius: 8px; }
        .selected-tag { background: white !important; color: #f56c6c !important; border: 1px solid #f56c6c !important; }
        
        /* 强制修复表格样式 */
        .el-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table__header-wrapper {
            width: 100% !important;
        }
        .el-table__header {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table__body-wrapper {
            width: 100% !important;
        }
        .el-table__body {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .el-table th, .el-table td {
            white-space: nowrap !important;
            text-align: left !important;
            padding: 12px 0 !important;
            border-right: 1px solid #EBEEF5 !important;
        }
        .el-table th:first-child, .el-table td:first-child {
            padding-left: 16px !important;
        }
        .el-table th:last-child, .el-table td:last-child {
            padding-right: 16px !important;
            border-right: none !important;
        }
        
        .el-menu--horizontal {
            border: none !important;
        }
        .el-sub-menu__hide-arrow {
            display: none !important;
        }
        .el-menu--horizontal {
            flex-wrap: nowrap !important;
        }
        .el-menu--horizontal .el-sub-menu {
            flex-shrink: 0 !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <!-- 顶部导航 -->
            <el-header class="header">
                <div style="display: flex; align-items: center; height: 100%;">
                    <el-menu 
                        mode="horizontal" 
                        :default-active="activeMenu" 
                        @select="handleMenuSelect"
                        background-color="#409EFF"
                        text-color="#fff"
                        active-text-color="#fff">
                        
                        <el-sub-menu index="1">
                            <template #title>Offer</template>
                            <el-menu-item index="adv-user">Adv User</el-menu-item>
                            <el-menu-item index="package-list">Package List</el-menu-item>
                            <el-menu-item index="offer-list">Offer List</el-menu-item>
                        </el-sub-menu>
                        
                        <el-sub-menu index="2">
                            <template #title>Channel</template>
                            <el-menu-item index="channel-list">Channel List</el-menu-item>
                        </el-sub-menu>
                        
                    </el-menu>
                </div>
            </el-header>

            <!-- 主内容区 -->
            <el-main class="main-container">
                <h2>Adv User 管理</h2>
                
                <!-- 筛选器 -->
                <div class="filter-section">
                    <el-row :gutter="20">
                        <el-col :span="8">
                            <el-select
                                v-model="selectedUser"
                                filterable
                                remote
                                reserve-keyword
                                placeholder="搜索 Adv User"
                                :remote-method="searchUsers"
                                :loading="searchLoading"
                                clearable
                                @change="handleUserFilter"
                                style="width: 100%">
                                <el-option
                                    v-for="user in searchResults"
                                    :key="user.username"
                                    :label="user.username"
                                    :value="user.username">
                                </el-option>
                            </el-select>
                        </el-col>
                        <el-col :span="4">
                            <el-button type="primary" @click="showCreateDialog = true">
                                <el-icon><Plus /></el-icon>
                                新建 Adv User
                            </el-button>
                        </el-col>
                    </el-row>
                </div>

                <!-- 数据表格 -->
                <el-table 
                    :data="paginatedUsers" 
                    v-loading="loading"
                    @sort-change="handleSortChange"
                    stripe
                    border
                    style="width: 100%">
                    <el-table-column prop="username" label="Username" sortable="custom" width="200" align="left"></el-table-column>
                    <el-table-column prop="bd" label="BD" width="150" align="left"></el-table-column>
                    <el-table-column prop="advPm" label="Adv PM" width="150" align="left"></el-table-column>
                    <el-table-column prop="updateTime" label="更新日期" sortable="custom" width="180" align="left"></el-table-column>
                    <el-table-column label="操作" width="280" align="center">
                        <template #default="scope">
                            <el-button size="small" @click="editUser(scope.row)">编辑</el-button>
                            <el-button size="small" type="primary" @click="managePackages(scope.row)">添加Package</el-button>
                            <el-button size="small" type="danger" @click="deleteUser(scope.row)">删除</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- 分页 -->
                <div style="margin-top: 20px; text-align: right;">
                    <el-pagination
                        v-model:current-page="currentPage"
                        v-model:page-size="pageSize"
                        :page-sizes="[10, 20, 50]"
                        :total="filteredUsers.length"
                        layout="total, sizes, prev, pager, next, jumper"
                        @size-change="handleSizeChange"
                        @current-change="handleCurrentChange">
                    </el-pagination>
                </div>
            </el-main>
        </el-container>

        <!-- 新建/编辑用户弹窗 -->
        <el-dialog 
            v-model="showCreateDialog" 
            :title="editingUser ? '编辑 Adv User' : '新建 Adv User'"
            width="500px">
            <el-form :model="userForm" :rules="userRules" ref="userFormRef" label-width="100px">
                <el-form-item label="Username" prop="username">
                    <el-input 
                        v-model="userForm.username" 
                        :disabled="editingUser"
                        placeholder="只支持英文字符、数字和下划线">
                    </el-input>
                </el-form-item>
                <el-form-item label="BD" prop="bd">
                    <el-select v-model="userForm.bd" placeholder="选择BD" style="width: 100%">
                        <el-option v-for="bd in bdList" :key="bd" :label="bd" :value="bd" />
                    </el-select>
                </el-form-item>
                <el-form-item label="Adv PM" prop="advPm">
                    <el-select v-model="userForm.advPm" placeholder="选择Adv PM" style="width: 100%">
                        <el-option v-for="pm in advPmList" :key="pm" :label="pm" :value="pm" />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showCreateDialog = false">取消</el-button>
                <el-button type="primary" @click="saveUser">保存</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // Firebase 配置 (使用演示配置)
        const firebaseConfig = {
            apiKey: "demo-key",
            authDomain: "demo.firebaseapp.com",
            projectId: "demo-project",
            storageBucket: "demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        createApp({
            setup() {
                // 响应式数据
                const activeMenu = ref('adv-user');
                const loading = ref(false);
                const searchLoading = ref(false);
                const showCreateDialog = ref(false);
                const editingUser = ref(null);
                const selectedUser = ref('');
                const searchResults = ref([]);
                const currentPage = ref(1);
                const pageSize = ref(20);
                const sortField = ref('updateTime');
                const sortOrder = ref('desc');

                // 表单数据
                const userForm = ref({
                    username: '',
                    bd: '',
                    advPm: ''
                });

                // 用户数据
                const users = ref([]);
                
                // 系统用户列表
                const bdList = ref(['张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '吴十']);
                const advPmList = ref(['刘一', '陈二', '杨三', '黄四', '朱五', '林六', '郭七', '何八']);

                // 表单验证规则
                const userRules = {
                    username: [
                        { required: true, message: '请输入Username', trigger: 'blur' },
                        { pattern: /^[a-zA-Z0-9_]+$/, message: '只支持英文字符、数字和下划线', trigger: 'blur' }
                    ],
                    bd: [{ required: true, message: '请选择BD', trigger: 'change' }],
                    advPm: [{ required: true, message: '请选择Adv PM', trigger: 'change' }]
                };

                // 计算属性
                const filteredUsers = computed(() => {
                    let result = users.value;
                    if (selectedUser.value) {
                        result = result.filter(user => user.username.includes(selectedUser.value));
                    }
                    
                    // 排序
                    result.sort((a, b) => {
                        const aVal = a[sortField.value];
                        const bVal = b[sortField.value];
                        if (sortOrder.value === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                    
                    return result;
                });

                const paginatedUsers = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filteredUsers.value.slice(start, end);
                });

                // 方法
                const handleMenuSelect = (key) => {
                    activeMenu.value = key;
                    if (key === 'package-list') {
                        window.location.href = './package-list.html';
                    } else if (key === 'offer-list') {
                        window.location.href = './index.html';
                    } else if (key === 'channel-list') {
                        window.location.href = './channel-list.html';
                    }
                };

                const searchUsers = (query) => {
                    if (query) {
                        searchLoading.value = true;
                        setTimeout(() => {
                            searchResults.value = users.value.filter(user => 
                                user.username.toLowerCase().includes(query.toLowerCase())
                            );
                            searchLoading.value = false;
                        }, 200);
                    } else {
                        searchResults.value = [];
                    }
                };

                const handleUserFilter = (value) => {
                    selectedUser.value = value;
                    currentPage.value = 1;
                };

                const clearUserFilter = () => {
                    selectedUser.value = '';
                    currentPage.value = 1;
                };

                const handleSortChange = ({ prop, order }) => {
                    sortField.value = prop;
                    sortOrder.value = order === 'ascending' ? 'asc' : 'desc';
                };

                const handleSizeChange = (size) => {
                    pageSize.value = size;
                    currentPage.value = 1;
                };

                const handleCurrentChange = (page) => {
                    currentPage.value = page;
                };

                const editUser = (user) => {
                    editingUser.value = user;
                    userForm.value = { ...user };
                    showCreateDialog.value = true;
                };

                const managePackages = (user) => {
                    const url = `./package-list.html?username=${encodeURIComponent(user.username)}&action=add`;
                    window.open(url, '_blank');
                };

                const deleteUser = async (user) => {
                    try {
                        await ElMessageBox.confirm('确定要删除这个用户吗？', '确认删除', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const index = users.value.findIndex(u => u.username === user.username);
                        if (index > -1) {
                            users.value.splice(index, 1);
                            saveToStorage();
                            ElMessage.success('删除成功');
                        }
                    } catch {
                        // 用户取消删除
                    }
                };

                const saveUser = async () => {
                    const formRef = document.querySelector('.el-form');
                    if (!formRef) return;
                    
                    // 简单验证
                    if (!userForm.value.username || !userForm.value.bd || !userForm.value.advPm) {
                        ElMessage.error('请填写完整信息');
                        return;
                    }
                    
                    if (!/^[a-zA-Z0-9_]+$/.test(userForm.value.username)) {
                        ElMessage.error('Username只支持英文字符、数字和下划线');
                        return;
                    }

                    const now = new Date().toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(/\//g, '-');

                    if (editingUser.value) {
                        // 编辑
                        const index = users.value.findIndex(u => u.username === editingUser.value.username);
                        if (index > -1) {
                            users.value[index] = {
                                ...userForm.value,
                                updateTime: now
                            };
                        }
                        ElMessage.success('更新成功');
                    } else {
                        // 新建
                        if (users.value.some(u => u.username === userForm.value.username)) {
                            ElMessage.error('Username已存在');
                            return;
                        }
                        
                        users.value.push({
                            ...userForm.value,
                            updateTime: now
                        });
                        ElMessage.success('创建成功');
                    }

                    saveToStorage();
                    showCreateDialog.value = false;
                    editingUser.value = null;
                    userForm.value = { username: '', bd: '', advPm: '' };
                };

                const saveToStorage = () => {
                    localStorage.setItem('advUsers', JSON.stringify(users.value));
                };

                const loadFromStorage = () => {
                    try {
                        const stored = localStorage.getItem('advUsers');
                        if (stored) {
                            users.value = JSON.parse(stored);
                        } else {
                            // 初始化示例数据
                            initSampleData();
                        }
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        initSampleData();
                    }
                };

                const initSampleData = () => {
                    users.value = [
                        { username: 'demo_user_1', bd: '张三', advPm: '刘一', updateTime: '2025-01-15 10:30:25' },
                        { username: 'test_advertiser', bd: '李四', advPm: '陈二', updateTime: '2025-01-14 16:45:12' },
                        { username: 'sample_client', bd: '王五', advPm: '杨三', updateTime: '2025-01-13 09:15:33' },
                        { username: 'mobile_app_user', bd: '赵六', advPm: '黄四', updateTime: '2025-01-12 14:20:18' },
                        { username: 'web_platform_client', bd: '钱七', advPm: '朱五', updateTime: '2025-01-11 09:45:30' }
                    ];
                    saveToStorage();
                };

                // 生命周期
                onMounted(() => {
                    console.log('组件挂载，开始加载数据');
                    loadFromStorage();
                    console.log('数据加载完成，用户数量:', users.value.length);
                });

                return {
                    activeMenu,
                    loading,
                    searchLoading,
                    showCreateDialog,
                    editingUser,
                    selectedUser,
                    searchResults,
                    currentPage,
                    pageSize,
                    userForm,
                    users,
                    bdList,
                    advPmList,
                    userRules,
                    filteredUsers,
                    paginatedUsers,
                    handleMenuSelect,
                    searchUsers,
                    handleUserFilter,
                    clearUserFilter,
                    handleSortChange,
                    handleSizeChange,
                    handleCurrentChange,
                    editUser,
                    managePackages,
                    deleteUser,
                    saveUser,
                    initSampleData
                };
            }
        }).use(ElementPlus, {
            // Element Plus 配置
        }).mount('#app');
    </script>
</body>
</html>