<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package List 管理</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .header { background: #409EFF; color: white; padding: 0 20px; height: 60px; line-height: 60px; }
        .main-container { padding: 20px; }
        
        /* 确保菜单正常显示 */
        .el-menu--horizontal {
            display: flex;
            align-items: center;
        }
        .el-menu--horizontal .el-menu-item,
        .el-menu--horizontal .el-sub-menu {
            color: #fff !important;
        }
        .el-menu--horizontal .el-sub-menu__title {
            color: #fff !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <!-- 顶部导航 -->
            <el-header class="header">
                <div style="display: flex; align-items: center; height: 100%;">
                    <el-menu mode="horizontal" :default-active="activeMenu" @select="handleMenuSelect" 
                             background-color="#409EFF" text-color="#fff" active-text-color="#fff"
                             style="border: none;">
                        <el-sub-menu index="offer">
                            <template #title>Offer</template>
                            <el-menu-item index="adv-user">Adv User</el-menu-item>
                            <el-menu-item index="package-list">Package List</el-menu-item>
                            <el-menu-item index="offer-list">Offer List</el-menu-item>
                        </el-sub-menu>
                        <el-sub-menu index="channel">
                            <template #title>Channel</template>
                            <el-menu-item index="channel-list">Channel List</el-menu-item>
                        </el-sub-menu>
                    </el-menu>
                </div>
            </el-header>

            <!-- 主内容区 -->
            <el-main class="main-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Package List 管理</h2>
                    <el-button type="primary" @click="showAddDialog = true">添加 Package</el-button>
                </div>

                <!-- 筛选区域 -->
                <el-card style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <el-input v-model="filters.name" placeholder="搜索包名" style="width: 200px;" clearable />
                        <el-select v-model="filters.advUser" placeholder="Adv User" style="width: 150px;" clearable>
                            <el-option v-for="user in advUsers" :key="user.id" :label="user.name" :value="user.name" />
                        </el-select>
                        <el-select v-model="filters.status" placeholder="状态" style="width: 120px;" clearable>
                            <el-option label="活跃" value="active" />
                            <el-option label="暂停" value="paused" />
                        </el-select>
                        <el-button type="primary" @click="applyFilters">搜索</el-button>
                        <el-button @click="resetFilters">重置</el-button>
                    </div>
                </el-card>

                <!-- 数据表格 -->
                <el-table :data="filteredPackages" style="width: 100%" border>
                    <el-table-column prop="id" label="ID" width="80" />
                    <el-table-column prop="name" label="包名" width="200" />
                    <el-table-column prop="advUser" label="Adv User" width="150" />
                    <el-table-column prop="bundleId" label="Bundle ID" width="200" />
                    <el-table-column prop="platform" label="平台" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.platform === 'iOS' ? 'primary' : 'success'">
                                {{ scope.row.platform }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="状态" width="100">
                        <template #default="scope">
                            <el-tag :type="scope.row.status === 'active' ? 'success' : 'warning'">
                                {{ scope.row.status === 'active' ? '活跃' : '暂停' }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="createTime" label="创建时间" width="180" />
                    <el-table-column label="操作" width="150">
                        <template #default="scope">
                            <el-button size="small" @click="editPackage(scope.row)">编辑</el-button>
                            <el-button size="small" type="danger" @click="deletePackage(scope.row.id)">删除</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- 添加/编辑对话框 -->
                <el-drawer v-model="showAddDialog" :title="editingPackage ? '编辑 Package' : '添加 Package'" size="400px">
                    <el-form :model="packageForm" label-width="100px">
                        <el-form-item label="包名">
                            <el-input v-model="packageForm.name" />
                        </el-form-item>
                        <el-form-item label="Adv User">
                            <el-select v-model="packageForm.advUser" style="width: 100%;">
                                <el-option v-for="user in advUsers" :key="user.id" :label="user.name" :value="user.name" />
                            </el-select>
                        </el-form-item>
                        <el-form-item label="Bundle ID">
                            <el-input v-model="packageForm.bundleId" />
                        </el-form-item>
                        <el-form-item label="平台">
                            <el-select v-model="packageForm.platform" style="width: 100%;">
                                <el-option label="iOS" value="iOS" />
                                <el-option label="Android" value="Android" />
                            </el-select>
                        </el-form-item>
                        <el-form-item label="状态">
                            <el-select v-model="packageForm.status" style="width: 100%;">
                                <el-option label="活跃" value="active" />
                                <el-option label="暂停" value="paused" />
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <template #footer>
                        <el-button @click="showAddDialog = false">取消</el-button>
                        <el-button type="primary" @click="savePackage">保存</el-button>
                    </template>
                </el-drawer>
            </el-main>
        </el-container>
    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const activeMenu = ref('package-list');
                const showAddDialog = ref(false);
                const editingPackage = ref(null);
                const packages = ref([]);
                const filteredPackages = ref([]);
                const advUsers = ref([]);
                const filters = ref({ name: '', advUser: '', status: '' });
                const packageForm = ref({ name: '', advUser: '', bundleId: '', platform: 'iOS', status: 'active' });

                // 初始化数据
                const initData = () => {
                    // 加载 Adv Users
                    const savedUsers = localStorage.getItem('advUsers');
                    if (savedUsers) {
                        advUsers.value = JSON.parse(savedUsers);
                    } else {
                        advUsers.value = [
                            { id: 1, name: 'John Doe' },
                            { id: 2, name: 'Jane Smith' }
                        ];
                    }

                    // 加载 Packages
                    const saved = localStorage.getItem('packages');
                    if (saved) {
                        packages.value = JSON.parse(saved);
                    } else {
                        packages.value = [
                            { id: 1, name: 'Game App', advUser: 'John Doe', bundleId: 'com.example.game', platform: 'iOS', status: 'active', createTime: '2024-01-15 10:30' },
                            { id: 2, name: 'Social App', advUser: 'Jane Smith', bundleId: 'com.demo.social', platform: 'Android', status: 'paused', createTime: '2024-01-20 14:20' }
                        ];
                        saveData();
                    }
                    filteredPackages.value = [...packages.value];
                };

                const saveData = () => {
                    localStorage.setItem('packages', JSON.stringify(packages.value));
                };

                const applyFilters = () => {
                    filteredPackages.value = packages.value.filter(pkg => {
                        return (!filters.value.name || pkg.name.toLowerCase().includes(filters.value.name.toLowerCase())) &&
                               (!filters.value.advUser || pkg.advUser === filters.value.advUser) &&
                               (!filters.value.status || pkg.status === filters.value.status);
                    });
                };

                const resetFilters = () => {
                    filters.value = { name: '', advUser: '', status: '' };
                    filteredPackages.value = [...packages.value];
                };

                const editPackage = (pkg) => {
                    editingPackage.value = pkg;
                    packageForm.value = { ...pkg };
                    showAddDialog.value = true;
                };

                const savePackage = () => {
                    if (editingPackage.value) {
                        const index = packages.value.findIndex(p => p.id === editingPackage.value.id);
                        packages.value[index] = { ...packageForm.value };
                    } else {
                        const newId = Math.max(...packages.value.map(p => p.id), 0) + 1;
                        packages.value.push({
                            ...packageForm.value,
                            id: newId,
                            createTime: new Date().toLocaleString('zh-CN')
                        });
                    }
                    saveData();
                    applyFilters();
                    showAddDialog.value = false;
                    editingPackage.value = null;
                    packageForm.value = { name: '', advUser: '', bundleId: '', platform: 'iOS', status: 'active' };
                };

                const deletePackage = (id) => {
                    packages.value = packages.value.filter(p => p.id !== id);
                    saveData();
                    applyFilters();
                };

                const handleMenuSelect = (key) => {
                    activeMenu.value = key;
                    if (key === 'adv-user') {
                        window.location.href = './adv-user.html';
                    } else if (key === 'offer-list') {
                        window.location.href = './index.html';
                    } else if (key === 'channel-list') {
                        window.location.href = './channel-list.html';
                    }
                };

                initData();

                return {
                    activeMenu, showAddDialog, editingPackage, packages, filteredPackages, advUsers, filters, packageForm,
                    handleMenuSelect, applyFilters, resetFilters, editPackage, savePackage, deletePackage
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>